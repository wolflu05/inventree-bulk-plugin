name: CI

on:
 push:
 pull_request:

jobs:
  style:
    name: Style checks
    if: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup python
        uses: actions/setup-python@v1
        with:
          python-version: 3.10.9

      - name: Install style check dependencies
        run: |
          pip install flake8==6.0.0
          pip install pep8-naming==0.13.2

      - name: Check style
        run: |
          flake8 .

  tests:
    name: Tests
    if: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup python
        uses: actions/setup-python@v1
        with:
          python-version: 3.10.9

      - name: Install tests dependencies
        run: |
          pip install pydantic==1.9.1
          pip install coverage==5.5

      - name: Run tests
        run: |
          cd inventree_bulk
          python -m coverage run -m unittest
          python -m coverage xml

      # - name: Coverage report
      #   run: |
      #     cd inventree_bulk
      #     python -m coverage report

      - name: Code Coverage Report
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: inventree_bulk/coverage.xml
          badge: true
          fail_below_min: false
          format: markdown
          hide_branch_rate: false
          hide_complexity: true
          indicators: true
          output: both
          thresholds: '50 80'

      - name: Get PR number
        uses: 8BitJonny/gh-get-current-pr@2.2.0
        id: pr
        with:
          sha: ${{ github.event.pull_request.head.sha }}
          filterOutClosed: true

      - name: Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: success() && steps.pr.outputs.number
        with:
          number: ${{ steps.pr.outputs.number }}
          recreate: true
          path: code-coverage-results.md
