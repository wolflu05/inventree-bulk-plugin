name: CI

on:
 push:
 pull_request:

jobs:
  style:
    name: 🧪 Style checks
    if: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install style check dependencies
        run: |
          pip install flake8==6.0.0
          pip install pep8-naming==0.13.2

      - name: Check style
        run: |
          flake8 .

  tests-unit:
    name: 🧪 Unit tests
    if: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install test dependencies
        run: |
          pip install pydantic==1.9.1
          pip install coverage==7.0.1

      - name: Run tests
        run: |
          python -m coverage run -m unittest discover -s inventree_bulk.tests.unit

  tests-integration:
    name: 🧪 Integration tests
    if: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
    runs-on: ubuntu-latest

    container:
      image: inventree/inventree:stable
      env:
        INVENTREE_DB_ENGINE: postgresql
        INVENTREE_DB_NAME: inventree
        INVENTREE_DB_HOST: db
        INVENTREE_DB_PORT: 5432
        INVENTREE_DB_USER: inventree
        INVENTREE_DB_PASSWORD: inventree
        INVENTREE_PLUGINS_ENABLED: True

    services:
      db:
        image: postgres:13
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: inventree
          POSTGRES_PASSWORD: inventree
          POSTGRES_DB: inventree

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup inventree
        run: |
          cd /home/inventree
          inv update

      - name: Setup inventree_bulk_plugin
        run: |
          cd /home/inventree
          pip install -e $GITHUB_WORKSPACE
          pip install coverage==6.0 # https://github.com/nedbat/coveragepy/issues/1150

      - name: Run tests
        run: |
          cd /home/inventree
          coverage run --omit="InvenTree/**" InvenTree/manage.py test inventree_bulk.tests.integration

      - name: Upload coverage
        uses: actions/upload-artifact@v2
        with:
          name: integration-coverage
          path: /home/inventree/.coverage

  report:
    name: 📝 Report
    needs: [tests-unit, tests-integration]
    if: false # ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) }}
    runs-on: ubuntu-latest
    steps:
      - name: Prepare reports
        run: |
          cd inventree_bulk
          python -m coverage json
          echo '## Coverage Report' > coverage.md
          coverage=$(jq -r ".totals.percent_covered" coverage.json | xargs printf "%.*f\n" "1")
          echo "![Code Coverage](https://img.shields.io/badge/Code%20Coverage-${coverage}%25-green?style=flat)" >> coverage.md
          python -m coverage report --format=markdown >> coverage.md

      - name: Get PR number
        uses: 8BitJonny/gh-get-current-pr@2.2.0
        id: pr
        with:
          sha: ${{ github.event.pull_request.head.sha }}
          filterOutClosed: true

      - name: Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: success() && steps.pr.outputs.number
        with:
          number: ${{ steps.pr.outputs.number }}
          recreate: true
          path: inventree_bulk/coverage.md

      - name: Write to Job Summary
        run: cat inventree_bulk/coverage.md >> $GITHUB_STEP_SUMMARY
